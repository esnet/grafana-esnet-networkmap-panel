<html>
<head>
    <title>Embedded Map Demonstration Page</title>
    <!-- do imports in totally separate script tags to force resolution ordering -->
    <script type="module">
        import "./src/components/lib/leaflet.global.js";
    </script>
    <script type="module">
        import "./src/components/lib/d3.min.js"; 
    </script>
    <script type="module">
        import "./src/components/MapCanvas.component.js";
    </script>

    <script type="module">
        import { sanitizeTopology } from "./src/components/lib/topologyTools.js"
        var parsedData = {};
        var lavender = "rgb(202, 149, 229)"
        var topology = [
            {
                "name": "Test Layer",
                "layer": "test-layer",
                "pathLayout": {
                    "type": "curveCardinal",
                    "tension": 0.6
                },
                "edges":[
                    {
                        "name": "A--B",
                        "meta": {
                            "capacity": 100000000000,
                            "endpoint_identifiers": {
                                "pops": ["A","B"]
                            }
                        },
                        "azDisplayValue": "9.0141 Gbps",
                        "zaDisplayValue": "3.1506 Gbps",
                        "coordinates": [
                            [49.02,-105.99],
                            [45.81,-101.77],
                            [44.59,-96.06]
                        ],
                        "children": [],
                    },
                    {
                        "name": "B--C",
                        "meta": {
                            "capacity": 100000000000,
                            "endpoint_identifiers": {
                                "pops": ["B","C"]
                            }
                        },
                        "azDisplayValue": "9.898 Gbps",
                        "zaDisplayValue": "1.727 Gbps",
                        "coordinates":[[44.59,-96.06],[47.99,-93.86],[52.16,-93.95]],
                        "children":[],
                    },
                    {
                        "name": "A--C",
                        "meta": {
                            "capacity": 100000000000,
                            "endpoint_identifiers": {
                                "pops": ["A","C"]
                            }
                        },
                        "azDisplayValue": "8.9017 Gbps",
                        "zaDisplayValue": "3.5614 Gbps",
                        "coordinates":[[49.02,-105.99],[51.90,-100.72],[52.16,-93.95]],
                        "children":[],
                    }
                ],
                "nodes":[
                        {
                            "name":"A",
                            "meta":{},
                            "coordinate":[49.02,-105.99],
                            // "parents": [], // created in-memory
                            // "sort": "A" // created in-memory
                        },
                        {
                            "name":"B",
                            "meta":{},
                            "coordinate":[44.59,-96.06],
                            // "parents": [], // created in-memory
                            // "sort": "B" // created in-memory
                        },
                        {
                            "name":"C",
                            "meta":{},
                            "coordinate":[52.16,-93.95],
                            // "parents": ["E-Parent", "D-Parent"] // created in-memory
                            // "sort": "E-Parent.D-Parent.C" // created in-memory
                        },
                        {
                            "name":"D-Parent",
                            "meta":{ "svg": "<g><rect height='20' width='20' x='-10' y='-10' /></g>" },
                            "coordinate":[52.26,-93.95],
                            "children": ["C"],
                            // "parents": ["E-Parent"] // created in-memory
                            // "sort": "E-Parent.D-Parent" // created in-memory
                        },
                        {
                            "name": "E-Parent",
                            "meta": { "svg": "<g><rect height='30' width='30' x='-15' y='-15' /></g>" },
                            "coordinate":[52.36,-93.95],
                            "children": ["D-Parent"],
                            // "parents": [],
                            // "sort": "E-Parent"
                        }
                ]
            }
        ];
        // the facts we need to compile: node: [grandparent, parent]
        var options = {
            "initialViewStrategy": "viewport",
            "showSidebar": false,
            "showViewControls": true,
            "enableEdgeAnimation": true,
            "enableNodeAnimation": true,
            "enableScrolling": true,
            "enableEditing": true,
            "background":"#EDEDED",
            "multiLayerNodeSnap": false,
            "viewport": {
                "top": 43,
                "left": -141,
                "bottom": 53,
                "right": -41,
                "center": {
                    "lat":38.68,
                    "lng":-96.96,
                },
                "zoom":3.5
            },
            "tileset": {
                // global options
                // this string corresponds to options in RenderMap.js
                "geographic":"esri.shaded",
                // this string (or null) corresponds to options in RenderMap.js
                "boundaries":"toner.boundaries",
                // this string (or null) corresponds to options in RenderMap.js
                "labels": null,
            },
            "layers": [
                {
                    // layer 1 rendering options
                    "visible":true,
                    "color": lavender,
                    "endpointId":"pops",
                    "nodeWidth":4,
                    "edgeWidth":2,
                    "pathOffset":2,
                    "name":"Core Topology",
                    "legend":true,
                },
                {
                    // layer 2 rendering options
                    "layer":false,
                    "color": lavender,
                    "endpointId":"pops",
                    "nodeWidth":5,
                    "edgeWidth":3,
                    "pathOffset":3,
                    "name":"Site Topology",
                    "legend":true,
                },
                {
                    // layer 3 rendering options
                    "layer":false,
                    "color": lavender,
                    "endpointId":"pops",
                    "nodeHighlight":"red",
                    "nodeWidth":6.5,
                    "edgeWidth":2,
                    "pathOffset":1.5,
                    "name":"Peer Topology",
                    "legend":true,
                }
            ]
        };
        var canvas = document.createElement("esnet-map-canvas");
        var optionsElem = document.createElement('textarea');
        var dataElem = document.createElement('textarea');

        canvas.setAttribute('id', "demonstration-element");
        canvas.setAttribute('height', 400);
        canvas.topology = topology;
        canvas.options = options;
        canvas.updateOptions = function(options){
            optionsElem.value = JSON.stringify(options);
        }
        canvas.updateTopology = function(topology){
            var cleanTopology = [];
            for(var i=0; i<3; i++){
                if(topology[i]){
                    cleanTopology[i] = sanitizeTopology(topology[i]);
                }
            }
            dataElem.value = JSON.stringify(cleanTopology);
        }
        document.getElementById("mapContainer").append(canvas);


        canvas.updateTopology(topology);
        dataElem.style = "height: 300px; width: 100%;";
        dataElem.onChange = function(event){
            canvas.topology = JSON.parse(event.target.value);
        }
        document.getElementById("mapDataContainer").append(dataElem);

        optionsElem.value = JSON.stringify(options);
        optionsElem.style = "height: 300px; width: 100%;";
        optionsElem.onChange = function(event){
            canvas.options = JSON.parse(event.target.value);
        }
        document.getElementById("mapOptionsContainer").append(optionsElem);

    </script>

</head>
<body>
    <table style='width:100%;'>
        <tr>
            <th colspan='3'>
                <h1>Embedded Map Demonstration page</h1>
            </th>
        <tr>
            <td colspan='2' style='width:80%;'>
                <div id='mapContainer'>
                </div>
            </td>
            <td style='width:20%'>
                <a href='/?editPanel=true'>Edit Mode On</a><br />
                <a href='/'>Edit Mode Off</a><br />
                <input type="button" onClick="test()" value='test click'>
            </td>
        </tr>
        <tr>
            <td style='width:40%'>Map Data</td>
            <td style='width:40%'>Map Options</td>
            <td style='width:20%'></td>
        </tr>
        <tr>
            <td id='mapDataContainer'></td>
            <td id='mapOptionsContainer'></td>
        </tr>
    </table>
</body>
</html>